<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ‡ã‚¹ã‚±ãƒ« v9 (DB Link)</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#000000">

  <style>
    /* === å…¨ä½“è¨­å®š === */
    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
      font-family: sans-serif;
    }

    .video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }

    /* æ ç·š */
    #overlay-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    #guide-frame {
      border: 3px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
      width: 80%;
      height: 0;
      position: relative;
      box-sizing: border-box;
      transition: all 0.3s;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }

    .grid-cell {
      border: 1px solid rgba(0, 0, 0, 0.8);
    }

    /* UIå‘¨ã‚Š */
    .ui-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      pointer-events: none;
    }

    .ui-container>* {
      pointer-events: auto;
    }

    .zoom-control {
      width: 80%;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-size: 12px;
    }

    input[type=range] {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button.size-btn {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(50, 50, 50, 0.6);
      color: white;
      backdrop-filter: blur(4px);
      transition: all 0.3s;
    }

    button.size-btn.active {
      background: white;
      color: black;
      font-weight: bold;
      border-color: white;
    }

    /* ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    button.size-btn.locked {
      color: #aaa;
    }

    #shutter-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: white;
      border: 4px solid #ccc;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.1s;
    }

    #shutter-btn:active {
      transform: scale(0.9);
      background-color: #eee;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
    #user-status {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 20;
      pointer-events: auto;
    }

    #btn-login {
      background: white;
      color: #333;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    #user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid white;
      display: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
    #modal,
    #save-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
    }

    .modal-box {
      background: #222;
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      max-width: 80%;
    }

    /* èª²é‡‘ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³ */
    .btn-purchase-demo {
      background: linear-gradient(90deg, #FFD700, #FFA500);
      color: black;
      width: 100%;
      padding: 12px;
      border-radius: 20px;
      font-weight: bold;
      border: none;
      margin-top: 15px;
      cursor: pointer;
      font-size: 14px;
    }

    #preview-img {
      max-width: 100%;
      max-height: 50vh;
      border: 2px solid white;
      margin: 15px 0;
      display: block;
    }

    .btn-download {
      background: white;
      color: black;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
    }

    .btn-cancel {
      background: #555;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      margin-left: 10px;
      cursor: pointer;
    }

    canvas {
      display: none;
    }
  </style>
</head>

<body>

  <div id="user-status">
    <button id="btn-login" onclick="signIn()">G ãƒ­ã‚°ã‚¤ãƒ³</button>
    <img id="user-icon" src="" alt="user" onclick="alert('ãƒ­ã‚°ã‚¤ãƒ³ä¸­')">
  </div>

  <div class="video-container">
    <video id="camera-video" autoplay playsinline muted></video>
  </div>

  <div id="overlay-layer">
    <div id="guide-frame"></div>
  </div>

  <div class="ui-container">
    <div class="zoom-control">
      <span>ï¼</span>
      <input type="range" id="zoom-slider" min="1.0" max="3.0" step="0.1" value="1.0">
      <span>ï¼‹</span>
    </div>
    <div class="buttons" id="btn-container"></div>
    <button id="shutter-btn"></button>
  </div>

  <div id="modal">
    <div class="modal-box">
      <h3>ğŸ’ æœ‰æ–™æ©Ÿèƒ½</h3>
      <p>ã“ã®ã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯<br>Proãƒ—ãƒ©ãƒ³ã¸ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>

      <button class="btn-purchase-demo" onclick="simulatePurchase()">
        ã€ãƒ‡ãƒ¢ã€‘Â¥300ã§è§£é™¤ã™ã‚‹<br><span style="font-size:10px; font-weight:normal;">(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›¸ãæ›ãˆã¾ã™)</span>
      </button>

      <div style="margin-top:15px;">
        <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="save-modal">
    <div class="modal-box">
      <h3>æ’®å½±ã—ã¾ã—ãŸ</h3>
      <img id="preview-img" src="">
      <p style="font-size:12px; color:#aaa; margin-bottom:15px;">é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™</p>
      <a id="download-link" class="btn-download" download="deskel_art.png" href="#">ç”»åƒã‚’ä¿å­˜</a>
      <button class="btn-cancel" onclick="closeSaveModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <canvas id="photo-canvas"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    // Firestoreã®æ©Ÿèƒ½ã‚’è¿½åŠ 
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_A5BqSP48YSiZU90jFn94g1ccyCnKS1g",
      authDomain: "deskel-app.firebaseapp.com",
      projectId: "deskel-app",
      storageBucket: "deskel-app.firebasestorage.app",
      messagingSenderId: "1022422619356",
      appId: "1:1022422619356:web:c1a2008fafcf4499021019"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
    const provider = new GoogleAuthProvider();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª²é‡‘çŠ¶æ…‹ï¼ˆåˆæœŸå€¤ã¯Falseï¼‰
    let isUserPremium = false;
    let currentUser = null;

    // === 1. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ===
    window.signIn = () => {
      signInWithPopup(auth, provider).catch(e => alert(e.message));
    };

    // === 2. çŠ¶æ…‹ç›£è¦– & ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£å‹• ===
    onAuthStateChanged(auth, (user) => {
      const loginBtn = document.getElementById('btn-login');
      const userIcon = document.getElementById('user-icon');

      if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æ™‚
        currentUser = user;
        loginBtn.style.display = 'none';
        userIcon.style.display = 'block';
        userIcon.src = user.photoURL;

        // â˜…ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã™ã‚‹ï¼
        // "users" ã¨ã„ã†å¼•ãå‡ºã—ã®ã€"ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" ã®æ›¸é¡ã‚’è¦‹å¼µã‚‹
        onSnapshot(doc(db, "users", user.uid), (docSnap) => {
          if (docSnap.exists() && docSnap.data().isPremium) {
            // èª²é‡‘ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ãŸã‚‰
            isUserPremium = true;
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã§ã™");
          } else {
            isUserPremium = false;
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç„¡æ–™ä¼šå“¡ã§ã™");
          }
          // UIã‚’æ›´æ–°ï¼ˆéµãƒãƒ¼ã‚¯ã‚’æ¶ˆã—ãŸã‚Šä»˜ã‘ãŸã‚Šï¼‰
          renderButtons();
        });

      } else {
        // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚
        currentUser = null;
        isUserPremium = false;
        loginBtn.style.display = 'flex';
        userIcon.style.display = 'none';
        renderButtons();
      }
    });

    // === 3. èª²é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ===
    window.simulatePurchase = async () => {
      if (!currentUser) {
        alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        closeModal();
        return;
      }

      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã€ŒisPremium: trueã€ã‚’æ›¸ãè¾¼ã‚€
      try {
        await setDoc(doc(db, "users", currentUser.uid), {
          isPremium: true,
          email: currentUser.email,
          updatedAt: new Date()
        }, { merge: true });

        alert("è³¼å…¥å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼‰");
        closeModal();
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
      }
    };


    // === ä»¥ä¸‹ã€ã‚¢ãƒ—ãƒªæœ¬ä½“æ©Ÿèƒ½ ===
    const RATIO_DATA = [
      { id: 'standard', label: 'A4/B4 (210Ã—297)', ratio: 297 / 210, isPremium: false },
      { id: 'mokutan', label: 'æœ¨ç‚­ç´™ (500Ã—650)', ratio: 650 / 500, isPremium: true },
      { id: 'f-size', label: 'Fã‚µã‚¤ã‚º (F6ç­‰)', ratio: 410 / 318, isPremium: true },
      { id: 'square', label: 'æ­£æ–¹å½¢', ratio: 1.00, isPremium: true }
    ];

    let currentRatio = 297 / 210;
    let currentZoom = 1.0;

    const video = document.getElementById('camera-video');
    const frame = document.getElementById('guide-frame');
    const slider = document.getElementById('zoom-slider');
    const btnContainer = document.getElementById('btn-container');
    const modal = document.getElementById('modal');
    const saveModal = document.getElementById('save-modal');
    const previewImg = document.getElementById('preview-img');
    const downloadLink = document.getElementById('download-link');
    const canvas = document.getElementById('photo-canvas');
    const shutterBtn = document.getElementById('shutter-btn');

    for (let i = 0; i < 16; i++) {
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      frame.appendChild(cell);
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) { console.log("ã‚«ãƒ¡ãƒ©ãªã—"); }
    }

    function updateShape(ratio) {
      currentRatio = ratio;
      const sw = window.innerWidth;
      const sh = window.innerHeight;
      let w = sw * 0.85;
      let h = w * ratio;
      if (h > sh * 0.75) { h = sh * 0.75; w = h / ratio; }
      frame.style.width = w + 'px';
      frame.style.height = h + 'px';
    }

    slider.addEventListener('input', (e) => {
      currentZoom = parseFloat(e.target.value);
      video.style.transform = `scale(${currentZoom})`;
    });

    // ãƒœã‚¿ãƒ³æç”»é–¢æ•°ï¼ˆçŠ¶æ…‹ã«ã‚ˆã£ã¦æ›¸ãæ›ãˆã‚‹ãŸã‚é–¢æ•°åŒ–ï¼‰
    function renderButtons() {
      btnContainer.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

      RATIO_DATA.forEach((item, i) => {
        const btn = document.createElement('button');
        btn.className = 'size-btn';

        // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãªã‚‰ã€Œéµã€ã‚’è¡¨ç¤ºã—ãªã„
        // item.isPremium ãŒ true ã§ã‚‚ã€isUserPremium ãŒ true ãªã‚‰ãƒ­ãƒƒã‚¯è§£é™¤
        const isLocked = item.isPremium && !isUserPremium;

        btn.innerHTML = item.label + (isLocked ? ' ğŸ”’' : '');
        if (isLocked) btn.classList.add('locked');

        // ç¾åœ¨é¸æŠä¸­ã®æ¯”ç‡ãªã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
        // (ç°¡ç•¥åŒ–ã®ãŸã‚ã€ratioã§åˆ¤å®š)
        if (Math.abs(item.ratio - currentRatio) < 0.01) {
          btn.classList.add('active');
        }

        btn.onclick = () => {
          if (isLocked) {
            // ãƒ­ãƒƒã‚¯ä¸­ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            document.getElementById('modal').style.display = 'flex';
            return;
          }
          // è§£é™¤æ¸ˆã¿orç„¡æ–™ãªã‚‰åˆ‡ã‚Šæ›¿ãˆ
          document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          updateShape(item.ratio);
        };

        btnContainer.appendChild(btn);
      });
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«
    window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };
    window.closeSaveModal = () => { saveModal.style.display = 'none'; };

    shutterBtn.onclick = () => {
      const vW = video.videoWidth;
      const vH = video.videoHeight;
      if (!vW || !vH) return;

      const visibleW = vW / currentZoom;
      const visibleH = vH / currentZoom;
      let cropW, cropH;
      if (visibleH / visibleW > currentRatio) {
        cropW = visibleW;
        cropH = visibleW * currentRatio;
      } else {
        cropH = visibleH;
        cropW = visibleH / currentRatio;
      }
      const startX = (vW - cropW) / 2;
      const startY = (vH - cropH) / 2;

      canvas.width = cropW;
      canvas.height = cropH;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, cropW, cropH);

      ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.lineWidth = cropW * 0.005;
      for (let i = 1; i <= 3; i++) {
        const x = (cropW / 4) * i;
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, cropH); ctx.stroke();
      }
      for (let i = 1; i <= 3; i++) {
        const y = (cropH / 4) * i;
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cropW, y); ctx.stroke();
      }

      const dataURL = canvas.toDataURL('image/png');
      previewImg.src = dataURL;
      downloadLink.href = dataURL;
      saveModal.style.display = 'flex';
    };

    startCamera();
    updateShape(297 / 210); // åˆæœŸã‚µã‚¤ã‚º
    renderButtons(); // ãƒœã‚¿ãƒ³åˆæœŸæç”»
    window.addEventListener('resize', () => updateShape(currentRatio));
  </script>
</body>

</html>