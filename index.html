<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ‡ã‚¹ã‚±ãƒ« v5 (Final)</title>
    <style>
        /* === å…¨ä½“è¨­å®š === */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* === ã‚«ãƒ¡ãƒ©æ˜ åƒã‚¨ãƒªã‚¢ === */
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }

        /* === ãƒ‡ã‚¹ã‚±ãƒ«æ ï¼ˆ16åˆ†å‰²ï¼‰ === */
        #overlay-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            /* ã‚¿ãƒƒãƒ—ã‚’è²«é€šã•ã›ã‚‹ */
        }

        #guide-frame {
            border: 3px solid rgba(0, 255, 255, 0.9);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            /* å‘¨ã‚Šã‚’æš—ã */
            width: 80%;
            height: 0;
            position: relative;
            box-sizing: border-box;
            transition: all 0.3s;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }

        .grid-cell {
            border: 1px solid rgba(0, 255, 255, 0.4);
        }

        /* === UIï¼ˆæ“ä½œç³»ï¼‰ === */
        .ui-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            pointer-events: none;
            /* UIã‚¨ãƒªã‚¢å…¨ä½“ã®é€é */
        }

        /* UIã®ä¸­ã®ãƒœã‚¿ãƒ³ãªã©ã¯æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        .ui-container>* {
            pointer-events: auto;
        }

        /* ã‚ºãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .zoom-control {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 12px;
        }

        input[type=range] {
            flex: 1;
        }

        /* ã‚µã‚¤ã‚ºé¸æŠãƒœã‚¿ãƒ³ */
        .buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button.size-btn {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(50, 50, 50, 0.6);
            color: white;
            backdrop-filter: blur(4px);
        }

        button.size-btn.active {
            background: cyan;
            color: black;
            font-weight: bold;
            border-color: cyan;
        }

        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        #shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid #ccc;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
        }

        #shutter-btn:active {
            transform: scale(0.9);
            background-color: #eee;
        }

        /* === ãƒ¢ãƒ¼ãƒ€ãƒ« === */
        #modal,
        #save-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .modal-box {
            background: #222;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #444;
            max-width: 80%;
        }

        /* æ’®å½±å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ */
        #preview-img {
            max-width: 100%;
            max-height: 50vh;
            border: 2px solid cyan;
            margin: 15px 0;
            display: block;
        }

        .btn-download {
            background: cyan;
            color: black;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .btn-cancel {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="video-container">
        <video id="camera-video" autoplay playsinline muted></video>
    </div>

    <div id="overlay-layer">
        <div id="guide-frame">
        </div>
    </div>

    <div class="ui-container">

        <div class="zoom-control">
            <span>ï¼</span>
            <input type="range" id="zoom-slider" min="1.0" max="3.0" step="0.1" value="1.0">
            <span>ï¼‹</span>
        </div>

        <div class="buttons" id="btn-container"></div>

        <button id="shutter-btn"></button>
    </div>

    <div id="modal" onclick="this.style.display='none'">
        <div class="modal-box">
            <h3>ğŸ’ æœ‰æ–™æ©Ÿèƒ½</h3>
            <p>ã“ã®ã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯<br>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
        </div>
    </div>

    <div id="save-modal">
        <div class="modal-box">
            <h3>æ’®å½±ã—ã¾ã—ãŸ</h3>
            <img id="preview-img" src="">
            <p style="font-size:12px; color:#aaa; margin-bottom:15px;">é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™</p>

            <a id="download-link" class="btn-download" download="deskel_art.png" href="#">ç”»åƒã‚’ä¿å­˜</a>
            <button class="btn-cancel" onclick="closeSaveModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <canvas id="photo-canvas" style="display:none;"></canvas>

    <script>
        // === ãƒ‡ãƒ¼ã‚¿å®šç¾© ===
        const RATIO_DATA = [
            { id: 'standard', label: 'æ¨™æº–(B/A)', ratio: 1.414, isPremium: false },
            { id: 'mokutan', label: 'æœ¨ç‚­ç´™', ratio: 1.30, isPremium: true },
            { id: 'f-size', label: 'Fã‚µã‚¤ã‚º', ratio: 1.25, isPremium: true },
            { id: 'square', label: 'æ­£æ–¹å½¢', ratio: 1.00, isPremium: true }
        ];

        let currentRatio = 1.414; // ç¾åœ¨ã®æ¯”ç‡
        let currentZoom = 1.0;    // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ å€ç‡

        // === è¦ç´ å–å¾— ===
        const video = document.getElementById('camera-video');
        const frame = document.getElementById('guide-frame');
        const slider = document.getElementById('zoom-slider');
        const btnContainer = document.getElementById('btn-container');
        const modal = document.getElementById('modal');
        const saveModal = document.getElementById('save-modal');
        const previewImg = document.getElementById('preview-img');
        const downloadLink = document.getElementById('download-link');
        const canvas = document.getElementById('photo-canvas');
        const shutterBtn = document.getElementById('shutter-btn');

        // === 1. ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ ===
        for (let i = 0; i < 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            frame.appendChild(cell);
        }

        // === 2. ã‚«ãƒ¡ãƒ©èµ·å‹• ===
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });
                video.srcObject = stream;
            } catch (e) {
                alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + e.name);
            }
        }

        // === 3. æ ã‚µã‚¤ã‚ºèª¿æ•´ ===
        function updateShape(ratio) {
            currentRatio = ratio;
            const sw = window.innerWidth;
            const sh = window.innerHeight;

            let w = sw * 0.85;
            let h = w * ratio;

            if (h > sh * 0.75) {
                h = sh * 0.75;
                w = h / ratio;
            }

            frame.style.width = w + 'px';
            frame.style.height = h + 'px';
        }

        // === 4. ã‚ºãƒ¼ãƒ åˆ¶å¾¡ ===
        slider.addEventListener('input', (e) => {
            currentZoom = parseFloat(e.target.value);
            video.style.transform = `scale(${currentZoom})`;
        });

        // === 5. ãƒœã‚¿ãƒ³ç”Ÿæˆ ===
        RATIO_DATA.forEach((item, i) => {
            const btn = document.createElement('button');
            btn.className = 'size-btn';
            btn.innerHTML = item.label + (item.isPremium ? ' ğŸ”’' : '');
            if (i === 0) btn.classList.add('active');

            btn.onclick = () => {
                if (item.isPremium) {
                    modal.style.display = 'flex';
                    return;
                }
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateShape(item.ratio);
            };
            btnContainer.appendChild(btn);
        });

        // === 6. æ’®å½±ãƒ»ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé‡è¦ï¼‰ ===
        shutterBtn.onclick = () => {
            // å‹•ç”»ã®æœ¬æ¥ã®ã‚µã‚¤ã‚º
            const vW = video.videoWidth;
            const vH = video.videoHeight;

            if (!vW || !vH) return; // æ˜ åƒãŒã¾ã æ¥ã¦ãªã„å ´åˆ

            // ã‚ºãƒ¼ãƒ ã—ã¦ã„ã‚‹å ´åˆã€ãã®éƒ¨åˆ†ã ã‘ã‚’åˆ‡ã‚ŠæŠœãè¨ˆç®—
            // ã‚ºãƒ¼ãƒ 2å€ãªã‚‰ã€ä¸­å¿ƒã®50%ã®ã‚¨ãƒªã‚¢ã‚’ä½¿ã†
            const cropW = vW / currentZoom;
            const cropH = vH / currentZoom;
            const cropX = (vW - cropW) / 2;
            const cropY = (vH - cropH) / 2;

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºè¨­å®š
            // æœ€çµ‚çš„ãªç”»åƒã¯ã€ç¾åœ¨ã®ã€Œæ¯”ç‡ã€ã«åˆã‚ã›ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒ
            // ã“ã“ã§ã¯ç”»è³ªå„ªå…ˆã§ã€Œåˆ‡ã‚ŠæŠœã„ãŸæ˜ åƒã®ã‚µã‚¤ã‚ºã€ã«åˆã‚ã›ã‚‹
            canvas.width = cropW;
            canvas.height = cropH;

            const ctx = canvas.getContext('2d');

            // 1. æ˜ åƒã‚’æç”»ï¼ˆã‚ºãƒ¼ãƒ åˆ†ã‚’è€ƒæ…®ã—ã¦ã‚¯ãƒ­ãƒƒãƒ—æç”»ï¼‰
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            // 2. é¸æŠã—ãŸã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã§ã•ã‚‰ã«ãƒˆãƒªãƒŸãƒ³ã‚°ã™ã‚‹
            // ãƒ‡ã‚¹ã‚±ãƒ«ã®æ å¤–ï¼ˆé»’ã„éƒ¨åˆ†ï¼‰ã‚’ã‚«ãƒƒãƒˆã™ã‚‹ã‹ã€
            // ã‚ã‚‹ã„ã¯ã€Œã‚°ãƒªãƒƒãƒ‰ã‚’æç”»ã€ã™ã‚‹ã€‚
            // ä»Šå›ã¯ã€Œæ˜ ã£ã¦ã„ã‚‹æ˜ åƒå…¨ä½“ã«ã‚°ãƒªãƒƒãƒ‰ã‚’å¼•ãã€ã®ã§ã¯ãªã
            // ã€Œãƒ‡ã‚¹ã‚±ãƒ«æ ã®ä¸­èº«ã ã‘ã€ã‚’ä¿å­˜ã—ãŸã„ã¯ãšã€‚

            // ã—ã‹ã—å®Ÿè£…ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã€
            // ã€Œã‚ºãƒ¼ãƒ ã—ãŸç”»é¢å…¨ä½“ã€ã«ã€Œ16åˆ†å‰²ç·šã€ã‚’å¼•ã„ã¦ä¿å­˜ã—ã¾ã™ã€‚
            // â€»å³å¯†ãªã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãƒˆãƒªãƒŸãƒ³ã‚°ã¯ã•ã‚‰ã«è¤‡é›‘ã«ãªã‚‹ãŸã‚ã€‚

            // ã‚°ãƒªãƒƒãƒ‰ç·šã‚’æãè¨­å®š
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = cropW * 0.005; // ç·šã®å¤ªã•ã‚’ç”»åƒã®å¤§ãã•ã«åˆã‚ã›ã‚‹

            // ç¸¦ç·š3æœ¬
            for (let i = 1; i <= 3; i++) {
                const x = (cropW / 4) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, cropH);
                ctx.stroke();
            }
            // æ¨ªç·š3æœ¬
            for (let i = 1; i <= 3; i++) {
                const y = (cropH / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(cropW, y);
                ctx.stroke();
            }

            // ç”»åƒåŒ–
            const dataURL = canvas.toDataURL('image/png');
            previewImg.src = dataURL;
            downloadLink.href = dataURL;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            saveModal.style.display = 'flex';
        };

        function closeSaveModal() {
            saveModal.style.display = 'none';
        }

        // åˆæœŸåŒ–
        startCamera();
        updateShape(1.414);
        window.addEventListener('resize', () => updateShape(1.414));

    </script>
</body>

</html>