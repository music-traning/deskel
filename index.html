<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ‡ã‚¹ã‚±ãƒ« v7 (210x297 Exact)</title>
  <style>
    /* === å…¨ä½“è¨­å®š === */
    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
      font-family: sans-serif;
    }

    .video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }

    /* æ ç·šã¨ã‚°ãƒªãƒƒãƒ‰ */
    #overlay-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    #guide-frame {
      border: 3px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
      width: 80%;
      height: 0;
      position: relative;
      box-sizing: border-box;
      transition: all 0.3s;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }

    .grid-cell {
      border: 1px solid rgba(0, 0, 0, 0.8);
    }

    /* UIå‘¨ã‚Š */
    .ui-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
      padding-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      pointer-events: none;
    }

    .ui-container>* {
      pointer-events: auto;
    }

    .zoom-control {
      width: 80%;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-size: 12px;
    }

    input[type=range] {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button.size-btn {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(50, 50, 50, 0.6);
      color: white;
      backdrop-filter: blur(4px);
    }

    button.size-btn.active {
      background: white;
      color: black;
      font-weight: bold;
      border-color: white;
    }

    #shutter-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: white;
      border: 4px solid #ccc;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.1s;
    }

    #shutter-btn:active {
      transform: scale(0.9);
      background-color: #eee;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modal,
    #save-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
    }

    .modal-box {
      background: #222;
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      max-width: 80%;
    }

    #preview-img {
      max-width: 100%;
      max-height: 50vh;
      border: 2px solid white;
      margin: 15px 0;
      display: block;
    }

    .btn-download {
      background: white;
      color: black;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
    }

    .btn-cancel {
      background: #555;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      margin-left: 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div class="video-container">
    <video id="camera-video" autoplay playsinline muted></video>
  </div>

  <div id="overlay-layer">
    <div id="guide-frame"></div>
  </div>

  <div class="ui-container">
    <div class="zoom-control">
      <span>ï¼</span>
      <input type="range" id="zoom-slider" min="1.0" max="3.0" step="0.1" value="1.0">
      <span>ï¼‹</span>
    </div>
    <div class="buttons" id="btn-container"></div>
    <button id="shutter-btn"></button>
  </div>

  <div id="modal" onclick="this.style.display='none'">
    <div class="modal-box">
      <h3>ğŸ’ æœ‰æ–™æ©Ÿèƒ½</h3>
      <p>ã“ã®ã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯<br>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
    </div>
  </div>

  <div id="save-modal">
    <div class="modal-box">
      <h3>æ’®å½±ã—ã¾ã—ãŸ</h3>
      <img id="preview-img" src="">
      <p style="font-size:12px; color:#aaa; margin-bottom:15px;">é•·æŠ¼ã—ã§ä¿å­˜ã§ãã¾ã™</p>
      <a id="download-link" class="btn-download" download="deskel_art.png" href="#">ç”»åƒã‚’ä¿å­˜</a>
      <button class="btn-cancel" onclick="closeSaveModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <canvas id="photo-canvas" style="display:none;"></canvas>

  <script>
    // === ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆã“ã“ã‚’å³å¯†ã«ã—ã¾ã—ãŸï¼‰ ===
    const RATIO_DATA = [
      {
        id: 'standard',
        label: 'A4/B4 (210Ã—297)', // è¡¨è¨˜ã‚’ã‚ã‹ã‚Šã‚„ã™ã
        ratio: 297 / 210,         // è¨ˆç®—å¼ã‚’å…¥ã‚Œã¦å®Œå…¨ä¸€è‡´ã•ã›ã‚‹
        isPremium: false
      },
      {
        id: 'mokutan',
        label: 'æœ¨ç‚­ç´™ (500Ã—650)',
        ratio: 650 / 500,        // 1.3
        isPremium: true
      },
      {
        id: 'f-size',
        label: 'Fã‚µã‚¤ã‚º (F6ç­‰)',
        ratio: 410 / 318,        // F6ã‚µã‚¤ã‚º(410x318mm)ã‚’åŸºæº–ã«è¨­å®š
        isPremium: true
      },
      {
        id: 'square',
        label: 'æ­£æ–¹å½¢',
        ratio: 1.00,
        isPremium: true
      }
    ];

    let currentRatio = 297 / 210;
    let currentZoom = 1.0;

    const video = document.getElementById('camera-video');
    const frame = document.getElementById('guide-frame');
    const slider = document.getElementById('zoom-slider');
    const btnContainer = document.getElementById('btn-container');
    const modal = document.getElementById('modal');
    const saveModal = document.getElementById('save-modal');
    const previewImg = document.getElementById('preview-img');
    const downloadLink = document.getElementById('download-link');
    const canvas = document.getElementById('photo-canvas');
    const shutterBtn = document.getElementById('shutter-btn');

    // ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
    for (let i = 0; i < 16; i++) {
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      frame.appendChild(cell);
    }

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) {
        // PCç­‰ã§ã‚«ãƒ¡ãƒ©ãŒãªã„å ´åˆã§ã‚‚å‹•ä½œç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        console.log("ã‚«ãƒ¡ãƒ©ãªã—ãƒ¢ãƒ¼ãƒ‰");
      }
    }

    // æ ã‚µã‚¤ã‚ºèª¿æ•´
    function updateShape(ratio) {
      currentRatio = ratio;
      const sw = window.innerWidth;
      const sh = window.innerHeight;
      let w = sw * 0.85;
      let h = w * ratio;
      if (h > sh * 0.75) {
        h = sh * 0.75;
        w = h / ratio;
      }
      frame.style.width = w + 'px';
      frame.style.height = h + 'px';
    }

    slider.addEventListener('input', (e) => {
      currentZoom = parseFloat(e.target.value);
      video.style.transform = `scale(${currentZoom})`;
    });

    // ãƒœã‚¿ãƒ³ç”Ÿæˆ
    RATIO_DATA.forEach((item, i) => {
      const btn = document.createElement('button');
      btn.className = 'size-btn';
      btn.innerHTML = item.label + (item.isPremium ? ' ğŸ”’' : '');
      if (i === 0) btn.classList.add('active');

      btn.onclick = () => {
        if (item.isPremium) {
          modal.style.display = 'flex';
          return;
        }
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateShape(item.ratio);
      };
      btnContainer.appendChild(btn);
    });

    // æ’®å½±ï¼†ãƒˆãƒªãƒŸãƒ³ã‚°å‡¦ç†
    shutterBtn.onclick = () => {
      const vW = video.videoWidth;
      const vH = video.videoHeight;
      if (!vW || !vH) return;

      const visibleW = vW / currentZoom;
      const visibleH = vH / currentZoom;

      let cropW, cropH;

      // æ¯”ç‡ã«åˆã‚ã›ã¦ãƒˆãƒªãƒŸãƒ³ã‚°æ ã‚’æ±ºå®š
      if (visibleH / visibleW > currentRatio) {
        cropW = visibleW;
        cropH = visibleW * currentRatio;
      } else {
        cropH = visibleH;
        cropW = visibleH / currentRatio;
      }

      const startX = (vW - cropW) / 2;
      const startY = (vH - cropH) / 2;

      canvas.width = cropW;
      canvas.height = cropH;
      const ctx = canvas.getContext('2d');

      // ç”»åƒåˆ‡ã‚ŠæŠœãæç”»
      ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, cropW, cropH);

      // ã‚°ãƒªãƒƒãƒ‰ç·šæç”»ï¼ˆé»’ï¼‰
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.lineWidth = cropW * 0.005;

      for (let i = 1; i <= 3; i++) {
        const x = (cropW / 4) * i;
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, cropH); ctx.stroke();
      }
      for (let i = 1; i <= 3; i++) {
        const y = (cropH / 4) * i;
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cropW, y); ctx.stroke();
      }

      const dataURL = canvas.toDataURL('image/png');
      previewImg.src = dataURL;
      downloadLink.href = dataURL;
      saveModal.style.display = 'flex';
    };

    function closeSaveModal() {
      saveModal.style.display = 'none';
    }

    startCamera();
    // åˆæœŸå€¤ã‚’æ­£ç¢ºãª210x297æ¯”ç‡ã§ã‚»ãƒƒãƒˆ
    updateShape(297 / 210);
    window.addEventListener('resize', () => updateShape(currentRatio));

  </script>
</body>

</html>